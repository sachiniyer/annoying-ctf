networks:
  ctf:
    driver: bridge
    ipam:
      config:
        - subnet: 10.0.0.0/8
    attachable: true
  secure:
    driver: bridge
    ipam:
      config:
        - subnet: 192.168.0.0/16
    attachable: true

services:
  primary:
    restart: always
    build:
      context: ./primary
    ports:
      - "8080:3000"
    dns: 8.8.8.8
    dns_search: nothing.com
    networks:
      ctf:
        ipv4_address: 10.0.0.2
    volumes:
      - ./secondary/keys/key:/var/cache/fontconfig/cache.txt
      - ./primary/info:/info

  secondary:
    restart: always
    build:
      context: ./secondary
    dns: 10.99.28.123
    dns_search: nothing.com
    volumes:
      - ./secondary/info:/info
    networks:
      ctf:
        ipv4_address: 10.28.191.94

  dns1:
    restart: always
    image: strm/dnsmasq
    volumes:
      - ./dns1/dnsmasq.conf:/etc/dnsmasq.conf
    networks:
      ctf:
        ipv4_address: 10.0.0.3
    cap_add:
      - NET_ADMIN

  dns2:
    restart: always
    image: strm/dnsmasq
    volumes:
      - ./dns2/dnsmasq.conf:/etc/dnsmasq.conf
    networks:
      ctf:
        ipv4_address: 10.99.28.123
    cap_add:
      - NET_ADMIN

  html:
    restart: always
    build:
      context: ./html
    networks:
      ctf:
        ipv4_address: 10.32.9.1
      secure:
        ipv4_address: 192.168.0.5


  db:
    restart: always
    build:
      context: ./db
    environment:
      POSTGRES_USER: "${POSTGRES_USER}"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"
    networks:
      secure:
        ipv4_address: 192.168.0.4


  mqtt:
    restart: always
    image: eclipse-mosquitto
    networks:
      ctf:
        ipv4_address: 10.182.200.11
      secure:
        ipv4_address: 192.168.0.2
    volumes:
      - ./mqtt/conf:/mosquitto/config
      - ./mqtt/data:/mosquitto/data
      - ./mqtt/log:/mosquitto/log

  flag:
    restart: always
    build:
      context: ./sender
    networks:
      secure:
        ipv4_address: 192.168.0.3
    volumes:
      - ./db/entries_plain.txt:/usr/src/app/words.txt
